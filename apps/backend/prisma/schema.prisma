// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  ownerId   String   // Clerk user ID of the owner
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   OrganizationMember[]
  roles     Role[]
  invites   Invite[]

  @@map("organizations")
}

model Role {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  members        OrganizationMember[]
  invites        Invite[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name])
  @@map("roles")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  clerkUserId    String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  roleId         String?
  role           Role?        @relation(fields: [roleId], references: [id])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, clerkUserId])
  @@map("organization_members")
}

model Invite {
  id             String       @id @default(cuid())
  token          String       @unique
  email          String
  status         String       @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  expiresAt      DateTime

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  roleId         String?
  role           Role?        @relation(fields: [roleId], references: [id])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("invites")
}

// --- CRM Models ---

model User {
  id           String   @id @default(cuid())
  clerkId      String   @unique
  email        String   @unique
  name         String?
  eventContext String?  // "I plan weddings and corporate events"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  projects            Project[]
  suppliers           Supplier[]
  supplierCategories  SupplierCategory[]
  gmailWatch          GmailWatch?
  backfillRuns        BackfillRun[]
  supplierCandidates  SupplierCandidate[]

  @@map("users")
}

model SupplierCategory {
  id          String   @id @default(cuid())
  name        String   // Display name, e.g. "Florist"
  slug        String   @unique // Lowercase normalized, e.g. "florist"
  description String?  // "Floral design, bouquets, arrangements..."
  isSystem    Boolean  @default(false) // True for seeded system categories
  
  // Nullable for system categories, set for user-created
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Many-to-many with suppliers
  suppliers   SupplierToCategory[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("supplier_categories")
}

model Supplier {
  id        String   @id @default(cuid())
  name      String   // Business Name or Primary Contact Name
  notes     String?
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Many-to-many with categories
  categories         SupplierToCategory[]

  contactMethods     ContactMethod[]
  projectSuppliers   ProjectSupplier[]
  messages           Message[] // Aggregate messages for the supplier
  supplierCandidates SupplierCandidate[] // Candidates that became this supplier

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("suppliers")
}

// Junction table for Supplier <-> Category many-to-many
model SupplierToCategory {
  id          String   @id @default(cuid())
  
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  categoryId  String
  category    SupplierCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  isPrimary   Boolean  @default(false) // Main category for display purposes

  createdAt   DateTime @default(now())

  @@unique([supplierId, categoryId])
  @@map("supplier_to_categories")
}

model ContactMethod {
  id         String   @id @default(cuid())
  type       String   // "EMAIL", "PHONE", "WHATSAPP", etc.
  value      String   // actual email address or phone number
  label      String?  // e.g., "Main Office", "Emergency", "Bob's Cell"
  isPrimary  Boolean  @default(false)

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  messages   Message[] // Messages specifically via this method

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([value]) // Fast lookup for incoming webhooks
  @@map("contact_methods")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  type        String
  date        DateTime?
  budget      Decimal? @db.Decimal(10, 2)
  description String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  suppliers ProjectSupplier[]
  messages  Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

model ProjectSupplier {
  id             String   @id @default(cuid())
  
  projectId      String
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  supplierId     String
  supplier       Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  role           String
  status         String   @default("NEEDED")
  quoteAmount    Decimal? @db.Decimal(10, 2)
  notes          String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([projectId, supplierId])
  @@map("project_suppliers")
}

model Message {
  id              String   @id @default(cuid())
  
  content         String   @db.Text
  direction       String   // "INBOUND", "OUTBOUND"
  sentAt          DateTime @default(now())
  externalId      String?  // External Message ID
  
  // Links
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  supplierId      String?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  
  contactMethodId String?
  contactMethod   ContactMethod? @relation(fields: [contactMethodId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("messages")
}

model GmailWatch {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailAddress String
  historyId    String
  expiration   BigInt
  updatedAt    DateTime @updatedAt

  @@map("gmail_watches")
}

// --- Inbox Backfill Models ---

model BackfillRun {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  status             String   @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED
  timeframeMonths    Int      @default(6)
  gmailQuery         String   // e.g. "in:sent newer_than:6m"
  nextPageToken      String?  // For resuming Gmail pagination
  eventContext       String?  // User's event types for AI context
  
  // Discovery progress counters
  scannedMessages    Int      @default(0)
  discoveredContacts Int      @default(0)
  createdCandidates  Int      @default(0)
  errorsCount        Int      @default(0)

  // Enrichment phase tracking
  enrichmentStatus   String   @default("PENDING") // PENDING, RUNNING, COMPLETED
  enrichedCount      Int      @default(0)
  autoImportedCount  Int      @default(0)

  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("backfill_runs")
}

model SupplierCandidate {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  email                 String   // Normalized email
  domain                String   // Domain extracted from email
  displayName           String?  // Best-effort display name from email header

  source                String   @default("GMAIL_SENT") // GMAIL_SENT, MANUAL, etc.
  status                String   @default("NEW") // NEW, ACCEPTED, DISMISSED, MERGED

  // Stats from scan
  messageCount          Int      @default(1)
  firstSeenAt           DateTime @default(now())
  lastSeenAt            DateTime @default(now())

  // AI suggestions
  suggestedSupplierName String?
  suggestedCategories   String[] // Array of category slugs, e.g. ["photography", "videography"]
  primaryCategory       String?  // Main category slug for display
  confidence            Float?   // 0-1
  isRelevant            Boolean? // AI determined if this is a relevant supplier
  enrichmentJson        Json?    // Raw enrichment result

  // If accepted, link to created supplier
  supplierId            String?
  supplier              Supplier? @relation(fields: [supplierId], references: [id])

  enrichmentJobs        SupplierEnrichmentJob[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([userId, email])
  @@index([userId, status])
  @@index([domain])
  @@map("supplier_candidates")
}

model SupplierEnrichmentJob {
  id            String   @id @default(cuid())
  userId        String
  candidateId   String
  candidate     SupplierCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  provider      String   // openai, anthropic
  model         String   // gpt-4o-mini, etc.
  promptVersion String   @default("v1")
  inputHash     String   // Hash of input data for caching
  
  resultJson    Json?
  confidence    Float?
  errorMessage  String?

  createdAt     DateTime @default(now())

  @@index([inputHash])
  @@map("supplier_enrichment_jobs")
}

// Global domain info cache (shared across users for efficiency)
model DomainInfo {
  id            String   @id @default(cuid())
  domain        String   @unique // e.g. "floristshop.com"
  
  // Scraped/enriched data
  title         String?
  description   String?
  industry      String?
  services      String?
  
  // Enrichment metadata
  lastFetchedAt DateTime?
  fetchError    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("domain_info")
}
